<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Transfer Game Earnings to TIFFY</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<style>
  body {
    background: url('ATM.gif') center center/cover no-repeat fixed;
    color: #0ff;
    font-family: 'Orbitron', sans-serif;
    text-align: center;
    padding: 20px;
  }
  h1 {
    text-shadow: 0 0 20px #00faff, 0 0 40px #00faff;
    margin-bottom: 30px;
    font-weight: 700;
  }
  .card {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border: 1px solid #0ff;
    border-radius: 16px;
    display: inline-block;
    box-shadow: 0 0 25px #0ff, inset 0 0 40px rgba(0,255,255,0.2);
    backdrop-filter: blur(12px);
    margin-top: 20px;
    transition: all 0.4s ease;
    min-width: 280px;
  }
  .btn {
    margin-top: 20px;
    padding: 14px 30px;
    font-size: 18px;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: all 0.3s ease;
  }
  #connectBtn {
    background: rgba(0, 200, 255, 0.15);
    border: 1px solid #0ff;
    color: #0ff;
    box-shadow: 0 0 20px #00faff, 0 0 40px #00faff;
    backdrop-filter: blur(8px);
    animation: pulseBlue 1.8s infinite;
  }
  #connectBtn:hover {
    background: rgba(0, 200, 255, 0.3);
    transform: scale(1.08);
    box-shadow: 0 0 30px #00faff, 0 0 70px #00faff;
  }
  @keyframes pulseBlue {
    0% { box-shadow: 0 0 15px #00faff, 0 0 25px #00faff; }
    50% { box-shadow: 0 0 40px #00faff, 0 0 70px #00faff; }
    100% { box-shadow: 0 0 15px #00faff, 0 0 25px #00faff; }
  }
  .browser-btn {
    background: rgba(147, 20, 255, 0.15);
    border: 1px solid mediumpurple;
    color: mediumpurple;
    box-shadow: 0 0 20px mediumpurple, 0 0 40px mediumpurple;
    backdrop-filter: blur(8px);
    animation: pulsePurple 1.8s infinite;
    margin-left: 10px;
  }
  .browser-btn:hover {
    background: rgba(147, 20, 255, 0.3);
    transform: scale(1.08);
    box-shadow: 0 0 30px mediumpurple, 0 0 70px mediumpurple;
  }
  @keyframes pulsePurple {
    0% { box-shadow: 0 0 15px mediumpurple, 0 0 25px mediumpurple; }
    50% { box-shadow: 0 0 40px mediumpurple, 0 0 70px mediumpurple; }
    100% { box-shadow: 0 0 15px mediumpurple, 0 0 25px mediumpurple; }
  }
  .transfer {
    background: rgba(255, 20, 147, 0.15);
    border: 1px solid hotpink;
    color: hotpink;
    box-shadow: 0 0 20px hotpink, 0 0 40px hotpink;
    backdrop-filter: blur(8px);
    animation: pulsePink 1.5s infinite;
  }
  .transfer:hover {
    background: rgba(255, 20, 147, 0.3);
    transform: scale(1.08);
    box-shadow: 0 0 30px hotpink, 0 0 70px hotpink;
  }
  @keyframes pulsePink {
    0% { box-shadow: 0 0 15px hotpink, 0 0 25px hotpink; }
    50% { box-shadow: 0 0 40px hotpink, 0 0 70px hotpink; }
    100% { box-shadow: 0 0 15px hotpink, 0 0 25px hotpink; }
  }
</style>
</head>
<body>

<h1>üöÄ Transfer Game Earnings</h1>

<audio id="clickSound" src="click.wav" preload="auto"></audio>

<button id="connectBtn" class="btn">Connect Wallet</button>
<button id="browserConnectBtn" class="btn browser-btn">Browser Connection</button>

<div class="card" id="transferCard" style="display:none">
  <div style="margin-bottom:8px"><strong>Wallet:</strong> <span id="walletAddress"></span></div>
  <div style="margin-bottom:6px"><strong>Claimed TIFFY:</strong> <span id="claimed">0</span></div>
  <div style="margin-bottom:6px"><strong>Synchronized Game Earnings:</strong> <span id="tetris">0</span></div>
  <div style="margin-top:10px;font-size:18px"><strong>Total Withdrawable:</strong> <span id="total">0</span></div>
  <button class="btn transfer" id="transferBtn" style="display:none">Transfer Now</button>
</div>

<script>
(async () => {
  let web3, provider, account;
  const clickSound = document.getElementById("clickSound");

  const wModal = new Web3Modal.default({
    cacheProvider: false,
    providerOptions: {
      walletconnect: {
        package: window.WalletConnectProvider?.default || {},
        options: {
          rpc: {
            56: "https://bsc-dataseed.binance.org/"
          }
        }
      }
    }
  });
  
  // Create the new "Withdraw to Wallet" button
  const withdrawBtn = document.createElement('button');
  withdrawBtn.id = 'withdrawToWalletBtn';
  withdrawBtn.className = 'btn transfer';
  withdrawBtn.textContent = 'Withdraw to Wallet';
  withdrawBtn.style.display = 'none';

  // Append the new button to the transferCard
  document.getElementById("transferCard").appendChild(withdrawBtn);


  document.getElementById("connectBtn").onclick = async () => {
    clickSound.play();
    provider = await wModal.connect();
    web3 = new Web3(provider);

    const cid = await web3.eth.getChainId();
    if (cid !== 56) {
      try {
        await provider.request({
          method: "wallet_switchEthereumChain",
          params: [{
            chainId: "0x38"
          }]
        });
      } catch (e) {
        if (provider.isBitget || provider.isBitKeep) {
          try {
            await provider.request({
              method: "wallet_addEthereumChain",
              params: [{
                chainId: "0x38",
                chainName: "BNB Smart Chain",
                rpcUrls: ["https://bsc-dataseed.binance.org/"],
                nativeCurrency: {
                  name: "BNB",
                  symbol: "BNB",
                  decimals: 18
                },
                blockExplorerUrls: ["https://bscscan.com"]
              }]
            });
          } catch {
            alert("üåê Bitget: please switch BSC manually.");
            return;
          }
        } else {
          alert("‚ùó Please switch to BNB Smart Chain");
          return;
        }
      }
    }

    const accts = await web3.eth.getAccounts();
    account = accts[0];

    // Shorten wallet display
    const shortAddr = account ? `${account.slice(0, 6)}...${account.slice(-4)}` : '';
    document.getElementById("walletAddress").textContent = shortAddr;

    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("browserConnectBtn").style.display = "none";
    document.getElementById("transferCard").style.display = "inline-block";
    loadBalances();
  };

  // NEW BUTTON LOGIC: Browser Connection
  document.getElementById("browserConnectBtn").onclick = () => {
    clickSound.play();
    document.getElementById("walletAddress").textContent = "Not Connected";
    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("browserConnectBtn").style.display = "none";
    document.getElementById("transferCard").style.display = "inline-block";
    loadBalances();
    
    // Show the new "Withdraw to Wallet" button and hide the old one
    withdrawBtn.style.display = 'inline-block';
    document.getElementById("transferBtn").style.display = 'none';
  };


  function getClaimed() {
    const key = `tiffyClaimed_browser`;
    return parseFloat(localStorage.getItem(key) || "0");
  }

  function getTetris() {
    return parseFloat(localStorage.getItem("tetrusScore") || "0");
  }

  function loadBalances() {
    const claimed = getClaimed();
    const tetris = getTetris();
    document.getElementById("claimed").textContent = claimed.toFixed(2);
    document.getElementById("tetris").textContent = tetris.toFixed(2);
    const total = claimed + tetris;
    document.getElementById("total").textContent = total.toFixed(2);
  }

  // Old "Transfer Now" button logic (remains for compatibility, but is hidden in the new flow)
  document.getElementById("transferBtn").onclick = () => {
    clickSound.play();
    const claimedKey = `tiffyClaimed_${account}`;
    const claimed = getClaimed();
    const tetris = getTetris();
    const newTotal = claimed + tetris;
    localStorage.setItem(claimedKey, newTotal.toString());
    localStorage.setItem("tetrusScore", "0");
    loadBalances();
    alert(`‚úÖ Transferred ${tetris.toFixed(2)} from your games earnings to your TIFFY Vault! All now ready to be withdrawn directly to your wallet. Just make sure you have a bit of BNB ready for gas!`);
  };

  // NEW "Withdraw to Wallet" button logic
  withdrawBtn.onclick = async () => {
    clickSound.play();
    
    // Step 1: Connect the wallet
    try {
      provider = await wModal.connect();
      web3 = new Web3(provider);
      const accts = await web3.eth.getAccounts();
      account = accts[0];

      // Step 2: Verify the chain ID
      const cid = await web3.eth.getChainId();
      if (cid !== 56) {
        alert("‚ùó Please switch to BNB Smart Chain");
        // We'll return here as the transaction cannot proceed on the wrong chain
        return;
      }

      // Step 3: Use local storage data for the transaction
      const amountToWithdraw = parseFloat(localStorage.getItem("tiffyClaimed_browser") || "0");

      if (amountToWithdraw <= 0) {
        alert("No TIFFY to withdraw.");
        return;
      }

      // Step 4: Initiate the transaction
      // This part requires you to define the smart contract's ABI and address.
      // REPLACE with your contract details
      const contractAddress = "0x...";
      const contractAbi = [
          // ABI for the claimStakingRewards function from the TiffyAI contract
          // Add other ABI functions as needed
          {"inputs":[],"name":"claimStakingRewards","outputs":[],"stateMutability":"nonpayable","type":"function"}
      ];
      
      const tiffyContract = new web3.eth.Contract(contractAbi, contractAddress);
      
      // Call the smart contract function
      alert("Transaction initiated! Please confirm in your wallet.");
      const transaction = await tiffyContract.methods.claimStakingRewards().send({ from: account });
      
      await transaction.wait();
      
      // Step 5: Update local storage and UI after successful transaction
      localStorage.setItem("tiffyClaimed_browser", "0");
      loadBalances();
      
      alert(`‚úÖ Transaction successful!`);
      withdrawBtn.style.display = 'none';

    } catch (error) {
      console.error("Transaction failed:", error);
      alert("Transaction failed: " + error.message);
    }
  };

})();
</script>

</body>
</html>
