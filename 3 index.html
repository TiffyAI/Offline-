<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Transfer Game Earnings to TIFFY</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
<script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
<style>
  body {
    background: url('ATM.gif') center center/cover no-repeat fixed;
    color: #0ff;
    font-family: 'Orbitron', sans-serif;
    text-align: center;
    padding: 20px;
  }
  h1 { text-shadow: 0 0 20px #00faff, 0 0 40px #00faff; margin-bottom: 30px; font-weight: 700; }
  .card {
    background: rgba(0, 0, 0, 0.3);
    padding: 20px;
    border: 1px solid #0ff;
    border-radius: 16px;
    display: inline-block;
    box-shadow: 0 0 25px #0ff, inset 0 0 40px rgba(0,255,255,0.2);
    backdrop-filter: blur(12px);
    margin-top: 20px;
    min-width: 280px;
  }
  .btn {
    margin-top: 20px; padding: 14px 30px; font-size: 18px;
    border: none; border-radius: 16px; cursor: pointer;
    font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 2px;
    transition: all 0.3s ease;
  }
  #connectBtn {
    background: rgba(0, 200, 255, 0.15); border: 1px solid #0ff; color: #0ff;
    box-shadow: 0 0 20px #00faff, 0 0 40px #00faff; backdrop-filter: blur(8px);
    animation: pulseBlue 1.8s infinite;
  }
  @keyframes pulseBlue { 0%{box-shadow:0 0 15px #00faff} 50%{box-shadow:0 0 40px #00faff} 100%{box-shadow:0 0 15px #00faff} }
  .browser-btn {
    background: rgba(147, 20, 255, 0.15); border: 1px solid mediumpurple; color: mediumpurple;
    box-shadow: 0 0 20px mediumpurple, 0 0 40px mediumpurple;
    animation: pulsePurple 1.8s infinite; margin-left: 10px;
  }
  @keyframes pulsePurple { 0%{box-shadow:0 0 15px mediumpurple} 50%{box-shadow:0 0 40px mediumpurple} 100%{box-shadow:0 0 15px mediumpurple} }
  .transfer {
    background: rgba(255, 20, 147, 0.15); border: 1px solid hotpink; color: hotpink;
    box-shadow: 0 0 20px hotpink, 0 0 40px hotpink; animation: pulsePink 1.5s infinite;
  }
  @keyframes pulsePink { 0%{box-shadow:0 0 15px hotpink} 50%{box-shadow:0 0 40px hotpink} 100%{box-shadow:0 0 15px hotpink} }
  /* New "lumo green" style for the Withdraw button */
  .withdraw-btn {
    background: rgba(147, 255, 20, 0.15);
    border: 1px solid #00ff00;
    color: #00ff00;
    box-shadow: 0 0 20px #00ff00, 0 0 40px #00ff00;
    animation: pulseGreen 1.5s infinite;
  }
  @keyframes pulseGreen { 0%{box-shadow:0 0 15px #00ff00} 50%{box-shadow:0 0 40px #00ff00} 100%{box-shadow:0 0 15px #00ff00} }

  /* Copied Wallet Popup styles from menu.html */
  .wallet-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
  }
  .wallet-popup-inner {
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid #00ffff;
      border-radius: 20px;
      padding: 30px 20px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 20px #ff00ff;
  }
  .wallet-btn {
      display: block;
      margin: 10px auto;
      padding: 12px;
      font-size: 16px;
      color: white;
      background-color: #111111;
      border: 1px solid #00ffff;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
  }
  .wallet-btn:hover {
      background: #00ffff33;
  }
  .close-popup {
      color: #ff00ff;
      font-size: 16px;
      margin-top: 12px;
      cursor: pointer;
      text-decoration: underline;
  }
</style>
</head>
<body>

<h1>🚀 Transfer Game Earnings</h1>
<audio id="clickSound" src="click.wav" preload="auto"></audio>

<button id="connectBtn" class="btn">Connect Wallet</button>
<button id="browserConnectBtn" class="btn browser-btn">Browser Connection</button>

<div class="card" id="transferCard" style="display:none">
  <div><strong>Wallet:</strong> <span id="walletAddress">Not Connected</span></div>
  <div><strong>Claimed TIFFY:</strong> <span id="claimed">0</span></div>
  <div><strong>Game Earnings:</strong> <span id="tetris">0</span></div>
  <div><strong>Total Withdrawable:</strong> <span id="total">0</span></div>
  <button class="btn withdraw-btn" id="withdrawBtn">Withdraw</button>
</div>

<div class="wallet-popup" id="walletPopup">
  <div class="wallet-popup-inner">
    <button class="wallet-btn" onclick="launchWallet('metamask')">MetaMask</button>
    <button class="wallet-btn" onclick="launchWallet('trust')">Trust Wallet</button>
    <button class="wallet-btn" onclick="launchWallet('okx')">OKX Wallet</button>
    <div class="close-popup" onclick="closePopup()">Close</div>
  </div>
</div>

<script>
(async ()=>{
  const cAddr = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
  const ABI = [
    {inputs:[],name:"claim",outputs:[],stateMutability:"payable",type:"function"},
    {inputs:[],name:"FIXED_BNB_FEE",outputs:[{internalType:"uint256",name:"",type:"uint256"}],stateMutability:"view",type:"function"}
  ];
  const BACKEND = "https://tiffyai-wh-wa.onrender.com/reward";
  let web3, provider, account, contract, fee;

  const clickSound = document.getElementById("clickSound");
  const wModal = new Web3Modal.default({
    cacheProvider:false,
    providerOptions:{ walletconnect:{ package:window.WalletConnectProvider?.default||{}, options:{ rpc:{56:"https://bsc-dataseed.binance.org/"}}}}
  });

  function getClaimed(){
    const key = account ? `tiffyClaimed_${account}` : "tiffyClaimed_browser";
    return parseFloat(localStorage.getItem(key) || "0");
  }
  function getTetris(){
    return parseFloat(localStorage.getItem("tetrusScore") || "0");
  }
  function loadBalances(){
    const claimed = getClaimed();
    const tetris = getTetris();
    const total = claimed + tetris;
    document.getElementById("claimed").textContent = claimed.toFixed(2);
    document.getElementById("tetris").textContent = tetris.toFixed(2);
    document.getElementById("total").textContent = total.toFixed(2);
  }

  // New functions for the pop-up
  function openPopup() {
    document.getElementById('walletPopup').style.display = 'flex';
  }

  function closePopup() {
    document.getElementById('walletPopup').style.display = 'none';
  }
  
  function launchWallet(wallet) {
    const currentUrl = window.location.href;
    closePopup();

    switch(wallet) {
      case 'metamask':
        window.location.href = `https://metamask.app.link/dapp/${currentUrl}`;
        break;
      case 'trust':
        window.location.href = `https://link.trustwallet.com/open_url?coin_id=60&url=${encodeURIComponent(currentUrl)}`;
        break;
      case 'okx':
        window.location.href = `okx://wallet/dapp/details?dappUrl=${encodeURIComponent(currentUrl)}`;
        break;
    }
  }

  // Keep original connection functions but adapt the flow
  async function connectWallet(){
    provider = await wModal.connect();
    web3 = new Web3(provider);
    const cid = await web3.eth.getChainId();
    if(cid !== 56){
      try { await provider.request({ method:"wallet_switchEthereumChain", params:[{chainId:"0x38"}] }); }
      catch(e){ alert("Please switch to BNB Smart Chain"); throw e; }
    }
    const accts = await web3.eth.getAccounts();
    account = accts[0];
    document.getElementById("walletAddress").textContent = `${account.slice(0,6)}...${account.slice(-4)}`;
    contract = new web3.eth.Contract(ABI, cAddr);
    fee = await contract.methods.FIXED_BNB_FEE().call();
  }

  async function withdraw(){
    const key = `tiffyClaimed_${account}`;
    let cnt = getClaimed() + getTetris();
    if(cnt <= 0) return;
    try {
      await contract.methods.claim().send({ from:account, value:fee });
      const backendAmt = cnt - 1;
      if(backendAmt > 0){
        await fetch(BACKEND,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({wallet:account,amount:backendAmt})});
      }
      localStorage.setItem(key,"0");
      localStorage.setItem("tetrusScore","0");
      loadBalances();
      alert("✅ Withdrawal Complete!");
    } catch(e){ alert("❌ Withdraw failed: "+(e.message||e)); }
  }

  // Initial setup when the page loads
  (async function init(){
    // Check if a wallet provider is already injected (meaning we are in a dApp browser)
    if (window.ethereum || window.web3) {
      await connectWallet();
      document.getElementById("connectBtn").style.display = "none";
      document.getElementById("browserConnectBtn").style.display = "none";
      document.getElementById("transferCard").style.display = "inline-block";
      loadBalances();
      
      // Auto-call withdraw() after wallet is connected.
      // This is the core of the new logic.
      await withdraw();
    } else {
      // If no wallet is injected, show the initial buttons
      document.getElementById("transferCard").style.display = "inline-block";
      loadBalances();
    }
  })();

  // Updated button click handlers for the new user flow
  document.getElementById("connectBtn").onclick = async() => {
    clickSound.play();
    await connectWallet();
    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("browserConnectBtn").style.display = "none";
    loadBalances();
  };

  document.getElementById("browserConnectBtn").onclick = () => {
    clickSound.play();
    account = null;
    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("browserConnectBtn").style.display = "none";
    loadBalances();
  };

  document.getElementById("withdrawBtn").onclick = async () => {
    clickSound.play();
    if(!account) {
        // If no account is connected yet, open the wallet popup to deep-link.
        // This is the key difference for the new flow.
        openPopup();
    } else {
        // If an account is already connected, just call withdraw.
        await withdraw();
    }
  };
})();
</script>

</body>
</html>
